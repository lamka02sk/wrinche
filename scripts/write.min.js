function ComponentController(d){this.components=d;function c(e){return e.value.trim()}function a(e){return e.innerText.trim()}function b(e){return(e.checked)}this.title={validate:function(){return(this.serialize().length<=100)},serialize:function(){return c(document.querySelector("input[name=write_title]"))}};this.excerpt={validate:function(){return(this.serialize().length<=360)},serialize:function(){return a(document.querySelector("textarea[name=write_excerpt]"))}};this.url={validate:function(){let serialize=this.serialize();return(serialize.length<=120&&/[a-zA-Z0-9-]/.test(serialize))},serialize:function(){return c(document.querySelector("input[name=write_url]"))}};this.pin={serialize:function(){return b(document.querySelector("input[name=write_pin]"))}};this.thumbnail={addThumbnail:function(f,e){let parent=document.querySelector("label[for=thumbnail]").parentNode;if(parent.querySelector("div.thumbnail-image.thumbnail-component-instance")){parent.removeChild(parent.querySelector("div.thumbnail-image.thumbnail-component-instance"))}let source;if(!e){source="app/Data/Files/Images/"+f}else{source=f}let template=parent.querySelector("#template_write_thumbnail_image").childNodes[0].cloneNode(true);template.setAttribute("data-path",f);template.classList.add("thumbnail-component-instance");template.childNodes[0].setAttribute("src",source);template.childNodes[0].setAttribute("alt",f);template.childNodes[1].innerText=f;parent.appendChild(template);template.childNodes[0].addEventListener("load",function(){parent.querySelector("div.input-box").classList.add("hide");$("div.media-manager span.close-manager").click();packery.packery().reloadItems()});document.querySelector("div.thumbnail-image.thumbnail-component-instance span.thumbnail-remove").addEventListener("click",function(){let instance=parent.querySelector("div.thumbnail-component-instance");parent.querySelector("div.input-box").classList.remove("hide");parent.removeChild(instance);packery.packery().reloadItems()})},events:[{event:"click",element:document.querySelector("label[for=thumbnail]").parentNode.querySelector("button.image_manager"),content:function(){managerActiveInstance=new MediaManager({onSelect:function(e){this.thumbnail.addThumbnail(e,false)}.bind(this)})}.bind(this)},{event:"change click keyup",element:document.querySelector("input[name=write_thumbnail]"),content:function(e){let input=e.target;let value=input.value;if(/[(http(s)?):\/\/(www\.)?a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/.test(value)){showValidationResult(input,"",true,function(){packery.packery().reloadItems()});if(e.keyCode&&e.keyCode===13){let testImage=new Image;testImage.onload=function(){this.thumbnail.addThumbnail(value,true)}.bind(this);testImage.onerror=function(){showValidationResult(input,"VALIDATION_URL_UNRESOLVED",false,function(){packery.packery().reloadItems()})}.bind(this);testImage.src=value}}else{showValidationResult(input,"VALIDATION_URL_INVALID",false,function(){packery.packery().reloadItems()})}}.bind(this)}],serialize:function(){if(document.querySelector("div.thumbnail-image.thumbnail-component-instance")){return document.querySelector("div.thumbnail-image.thumbnail-component-instance").getAttribute("data-path")}else{return false}}};this.perex={validate:function(){let serialize=this.serialize();return(serialize.location.length<=120)},serialize:function(){return{date:c(document.querySelector("input[name=write_perex_date]")),location:c(document.querySelector("input[name=write_perex_location"))}}};this.header_image={addHeaderImage:function(f,e){let parent=document.querySelector("label[for=header_image]").parentNode;if(parent.querySelector("div.header_image-image.header_image-component-instance")){parent.removeChild(parent.querySelector("div.header_image-image.header_image-component-instance"))}let source;if(!e){source="app/Data/Files/Images/"+f}else{source=f}let template=parent.querySelector("#template_write_header-image_image").childNodes[0].cloneNode(true);template.setAttribute("data-path",f);template.classList.add("header_image-component-instance");template.childNodes[0].setAttribute("src",source);template.childNodes[0].setAttribute("alt",f);template.childNodes[1].innerText=f;parent.appendChild(template);template.childNodes[0].addEventListener("load",function(){parent.querySelector("div.input-box").classList.add("hide");$("div.media-manager span.close-manager").click();packery.packery().reloadItems()});document.querySelector("div.header_image-image.header_image-component-instance span.header_image-remove").addEventListener("click",function(){let instance=parent.querySelector("div.header_image-component-instance");parent.querySelector("div.input-box").classList.remove("hide");parent.removeChild(instance);packery.packery().reloadItems()})},events:[{event:"click",element:document.querySelector("label[for=header_image]").parentNode.querySelector("button.image_manager"),content:function(){managerActiveInstance=new MediaManager({onSelect:function(e){this.header_image.addHeaderImage(e,false)}.bind(this)})}.bind(this)},{event:"change click keyup",element:document.querySelector("input[name=write_header-image]"),content:function(e){let input=e.target;let value=input.value;if(/[(http(s)?):\/\/(www\.)?a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/.test(value)){showValidationResult(input,"",true,function(){packery.packery().reloadItems()});if(e.keyCode&&e.keyCode===13){let testImage=new Image;testImage.onload=function(){this.header_image.addHeaderImage(value,true)}.bind(this);testImage.onerror=function(){showValidationResult(input,"VALIDATION_URL_UNRESOLVED",false,function(){packery.packery().reloadItems()})}.bind(this);testImage.src=value}}else{showValidationResult(input,"VALIDATION_URL_INVALID",false,function(){packery.packery().reloadItems()})}}.bind(this)}],serialize:function(){if(document.querySelector("div.header_image-image.header_image-component-instance")){return document.querySelector("div.header_image-image.header_image-component-instance").getAttribute("data-path")}else{return false}}};this.languages={start:function(){languages=getJson("app/Config/languages.json");let listElement=document.querySelector("div.languages-list");for(let abbr in languages){let targetSelect=document.querySelector("select[name=write_current_language]");let template=document.querySelector("#template_write_languages_item").childNodes[0].cloneNode(true);let localeString="LANGUAGE_"+languages[abbr].toUpperCase().split(";")[0];template.setAttribute("data-language",abbr);template.childNodes[0].setAttribute("data-locale",localeString);template.childNodes[0].innerText=languages[abbr];listElement.appendChild(template);template.childNodes[1].addEventListener("click",function(){let currentOptions=targetSelect.children;for(let i=0;i<currentOptions.length;++i){let currentOption=currentOptions[i];if(currentOption.getAttribute("data-locale")===localeString){return false}}let option=document.createElement("option");option.setAttribute("value",abbr);option.setAttribute("data-locale",localeString);option.innerText=translate.locale.system[localeString];targetSelect.appendChild(option);selector.destroy();selector=new Selector({selector:"select.selector-search-select"});template.childNodes[1].classList.add("hide");template.childNodes[2].classList.remove("hide")});template.childNodes[2].addEventListener("click",function(){let actionText=translate.locale.response.ACTION_CONFIRM_REMOVE_LANGUAGE.replace("%language%",translate.locale.system[localeString]);confirmAction(actionText,function(){let option=targetSelect.querySelector("option[data-locale="+localeString+"]");targetSelect.removeChild(option);selector.destroy();selector=new Selector({selector:"select.selector-search-select"});template.childNodes[2].classList.add("hide");template.childNodes[1].classList.remove("hide")})})}translate.addTranslation(["system"])},events:[{event:"keyup click change",element:document.querySelector("input[name=write_language_search]"),content:function(e){let searchPhrase=e.target.value.toLowerCase();let searchPhraseLength=searchPhrase.length;let listElements=document.querySelector("div.languages-list").childNodes;let listElementsLength=listElements.length;if(searchPhraseLength<3){for(let i=0;i<listElementsLength;++i){let abbr=listElements[i].getAttribute("data-language").substring(0,searchPhraseLength).toLowerCase();if(abbr===searchPhrase){listElements[i].classList.remove("hide")}else{listElements[i].classList.add("hide")}}packery.packery().reloadItems();return true}for(let i=0;i<listElementsLength;++i){let abbr=listElements[i].childNodes[0].innerText.substring(0,searchPhraseLength).toLowerCase();if(abbr===searchPhrase){listElements[i].classList.remove("hide")}else{listElements[i].classList.add("hide")}}packery.packery().reloadItems()}}]};this.attachments={addAttachment:function(e,f){let parent=document.querySelector("label[for=attachments]").parentNode;let attachmentsList=parent.querySelector("div.attachments-list");let path="app/Data/Files/";let type;if(f==="images"){path+="Images/";type="image"}else{if(f==="videos"){path+="Videos/";type="video"}else{if(f==="sounds"){path+="Sounds/";type="audio"}else{path+="Files/";type="file"}}}path+=e;let template=document.querySelector("#template_write_attachments_added").childNodes[0].cloneNode(true);template.classList.add("attachments-component-instance");template.setAttribute("data-path",path);template.classList.add("icon-"+type);template.childNodes[1].innerText=e;attachmentsList.insertBefore(template,attachmentsList.childNodes[0]);template.querySelector("span.attachment-remove").addEventListener("click",function(g){let instance=g.target.parentNode;instance.parentNode.removeChild(instance);packery.packery().reloadItems()});$("div.media-manager span.close-manager").click();packery.packery().reloadItems()},events:[{event:"click",element:document.querySelector("label[for=attachments]").parentNode.querySelectorAll("button.add-attachment"),content:function(e){let managerType=e.target.getAttribute("data-content");managerActiveInstance=new MediaManager({manager:managerType,onSelect:function(f){this.attachments.addAttachment(f,managerType)}.bind(this)})}.bind(this)}],serialize:function(){let attachmentsElements=document.querySelector("div.attachments-list").childNodes;let resultList=[];for(let i=0;i<attachmentsElements.length;++i){resultList.push(attachmentsElements[i].getAttribute("data-path"))}return resultList}};this.custom_fields={data:[],validateNew:function(){let parent=document.querySelector("div.custom_fields-add-box");let identifier=parent.querySelector("#custom_fields-add-name").value.trim();let value=parent.querySelector("#custom_fields-add-value").value.trim();let inData=false;for(let i=0;i<this.custom_fields.data.length;++i){if(this.custom_fields.data[i][0]===identifier){inData=true;break}}return !(identifier===""||value===""||inData)}.bind(this),validate:function(){let identifiers=[];for(let i=0;i<this.custom_fields.data.length;++i){let item=this.custom_fields.data[i];if(identifiers.indexOf(item[0])!==-1){return false}identifiers.push(item[0]);if(item[0]===""||item[1]===""){return false}}return true}.bind(this),serialize:function(){if(!this.custom_fields.validate()){return false}return this.custom_fields.data}.bind(this),edit:function(e){let identifier=e.childNodes[0].innerText;let value=e.childNodes[1].innerText;e.childNodes[2].click();let addBox=document.querySelector("div.custom_fields-add-box");addBox.querySelector("#custom_fields-add-name").value=identifier;addBox.querySelector("#custom_fields-add-value").value=value;addBox.querySelector("#custom_fields-add-name").focus()},events:[{event:"click",element:document.querySelector("span.add-custom_field"),content:function(){if(!this.custom_fields.validateNew()){return false}let parent=document.querySelector("div.custom_fields-add-box");let identifier=parent.querySelector("#custom_fields-add-name");let value=parent.querySelector("#custom_fields-add-value");let identifierValue=identifier.value.trim();let valueValue=value.value.trim();let data=[identifierValue,valueValue];this.custom_fields.data.push(data);let template=document.querySelector("#template_write_custom-fields_field").childNodes[0].cloneNode(true);template.childNodes[0].innerText=identifierValue;template.childNodes[1].innerText=valueValue;template.childNodes[3].addEventListener("click",function(e){let element=e.target.parentNode;this.custom_fields.edit(element)}.bind(this));template.childNodes[2].addEventListener("click",function(e){let element=e.target.parentNode;element.parentNode.removeChild(element);for(let i=0;i<this.custom_fields.data.length;++i){if(this.custom_fields.data[i][0]===identifierValue){this.custom_fields.data.splice(i,1);break}}packery.packery().reloadItems()}.bind(this));let list=parent.parentNode.querySelector("div.custom_fields-list");list.insertBefore(template,list.childNodes[0]);identifier.value="";value.value="";identifier.focus();packery.packery().reloadItems()}.bind(this)},{event:"keyup",element:document.querySelector("input#custom_fields-add-value"),content:function(e){if(e.keyCode&&e.keyCode===13){document.querySelector("span.add-custom_field").click()}}}]};this.tags={data:[],validate:function(){let value=document.querySelector("input[name=write_tags_add]").value.trim();return(/^[a-zA-Z][a-zA-Z0-9_\s,]+[a-zA-Z0-9]$/g.test(value)&&value!=="")},events:[{event:"keyup",element:document.querySelector("input[name=write_tags_add]"),content:function(e){if(e.keyCode&&e.keyCode===13){let value=e.target.value.trim();if(value===""){return false}if(!this.tags.validate()){return false}let tags=value.split(",");for(let i=0;i<tags.length;++i){let tag=tags[i].trim();if(this.tags.data.indexOf(tag)!==-1){continue}if(!this.tags.validate()){continue}let template=document.querySelector("#template_write_tags_item").childNodes[0].cloneNode(true);template.innerHTML="#"+tag+template.innerHTML;document.querySelector("div.tags-list").appendChild(template);this.tags.data.push(tag);template.childNodes[1].addEventListener("click",function(){let index=this.tags.data.indexOf(tag);this.tags.data.splice(index,1);template.parentNode.removeChild(template);packery.packery().reloadItems()}.bind(this))}e.target.value="";packery.packery().reloadItems()}}.bind(this)}]};this.revisions={};for(let i=0;i<this.components.length;++i){if(!(this.components[i] in this)){continue}if(this[this.components[i]].start){this[this.components[i]].start()}if(!this[this.components[i]]["events"]){continue}for(let j=0;j<this[this.components[i]]["events"].length;++j){let eventTemplate=this[this.components[i]]["events"][j];let eventList=eventTemplate.event.trim().split(" ");if(eventTemplate.element[0]!==undefined){for(let k=0;k<eventTemplate.element.length;++k){let element=eventTemplate.element[k];for(let l=0;l<eventList.length;++l){element.addEventListener(eventList[l],eventTemplate.content)}}}else{for(let k=0;k<eventList.length;++k){eventTemplate.element.addEventListener(eventList[k],eventTemplate.content)}}}}}componentList=["title","excerpt","url","pin","thumbnail","perex","header_image","languages","attachments","custom_fields","tags","revisions"];components=new ComponentController(componentList);previousScripts.push("write");$("div.counter").each(function(){let maxLen=$(this).attr("data-maxLength");$(this).text(maxLen);let current=$(this);let type=$(this).attr("data-input");if(type==="input"){let element=$(this).parent().find("input");element.on("change keydown keyup click focusout focusin",function(){let left=maxLen-element.val().trim().length;if(left<0){current.addClass("minus")}else{if(current.hasClass("minus")){current.removeClass("minus")}}current.text(left)})}else{let element=$(this).parent().find("textarea");element.on("change keydown keyup click focusout focusin",function(){let left=maxLen-element.val().trim().length;if(left<0){current.addClass("minus")}else{if(current.hasClass("minus")){current.removeClass("minus")}}current.text(left)})}});packery=$("div.content-settings").packery({itemSelector:"div.settings-component",gutter:22});$("span.collapse-trigger").click(function(){let element=$(this).parent().parent();if(element.hasClass("open")){element.animate({"max-height":"260px"},200).removeClass("open")}else{element.css({"max-height":"none"});let newHeight=element.height();element.css({"max-height":"260px"});element.animate({"max-height":newHeight},200).addClass("open");setTimeout(function(){element.css({"max-height":"none"})},200)}setTimeout(function(){packery.packery().reloadItems()},200)});selector=new Selector({selector:"select.selector-search-select"});initDatePicker();$("div.splash").addClass("done");