(function(a){if(typeof define==="function"&&define.amd){define(["jquery","./core","./scrollbar","./touch"],a)}else{a(jQuery,Formstone)}}(function(f,s){function y(){F=s.$body}function w(M){M.multiple=this.prop("multiple");M.disabled=this.is(":disabled")||this.is("[readonly]");M.lastIndex=false;if(M.multiple){M.links=false}else{if(M.external){M.links=true}}var O=this.find("[selected]").not(":disabled"),S=this.find(":selected").not(":disabled"),R=S.text(),P=this.find("option").index(S);if(!M.multiple&&M.label!==""&&!O.length){S=this.prepend('<option value="" class="'+u.item_placeholder+'" selected>'+M.label+"</option>");R=M.label;P=0}else{M.label=""}var L=this.find("option, optgroup"),N=L.filter("option"),Q=f("[for="+this.attr("id")+"]");M.tabIndex=this[0].tabIndex;this[0].tabIndex=-1;if(Q.length){Q[0].tabIndex=-1}var T=[u.base,M.theme,M.customClass];if(M.mobile||s.isMobile){T.push(u.mobile)}else{if(M.cover){T.push(u.cover)}}if(M.multiple){T.push(u.multiple)}if(M.disabled){T.push(u.disabled)}M.id=this.attr("id");if(M.id){M.ariaId=M.id}else{M.ariaId=M.rawGuid}M.ariaId+="-dropdown";M.selectedAriaId=M.ariaId+"-selected";var J="",K="";J+='<div class="'+T.join(" ")+'"id="'+M.ariaId+'" tabindex="'+M.tabIndex+'" role="listbox"';if(M.multiple){J+=' aria-label="multi select"'}else{J+=' aria-haspopup="true" aria-live="polite" aria-labeledby="'+M.selectedAriaId+'"'}J+="></div>";if(!M.multiple){K+='<button type="button" class="'+u.selected+'" id="'+M.selectedAriaId+'" tabindex="-1">';K+=f("<span></span>").text(H(R,M.trim)).html();K+="</button>"}K+='<div class="'+u.options+'">';K+="</div>";this.wrap(J).after(K);M.$dropdown=this.parent(n.base);M.$label=Q;M.$allOptions=L;M.$options=N;M.$selected=M.$dropdown.find(n.selected);M.$wrapper=M.$dropdown.find(n.options);M.$placeholder=M.$dropdown.find(n.placeholder);M.index=-1;M.closed=true;M.focused=false;D(M);if(!M.multiple){I(P,M)}if(f.fn.fsScrollbar!==undefined){M.$wrapper.fsScrollbar({theme:M.theme}).find(".fs-scrollbar-content").attr("tabindex",null)}M.$dropdown.on(r.click,M,g);M.$selected.on(r.click,M,g);M.$dropdown.on(r.click,n.item,M,G).on(r.close,M,d);this.on(r.change,M,C);if(!s.isMobile){this.on(r.focusIn,M,function(U){U.data.$dropdown.trigger(r.raw.focus)});M.$dropdown.on(r.focusIn,M,a).on(r.focusOut,M,v)}}function t(J){if(J.$dropdown.hasClass(u.open)){J.$selected.trigger(r.click)}if(f.fn.fsScrollbar!==undefined){J.$wrapper.fsScrollbar("destroy")}J.$el[0].tabIndex=J.tabIndex;if(J.$label.length){J.$label[0].tabIndex=J.tabIndex}J.$dropdown.off(r.namespace);J.$options.off(r.namespace);J.$placeholder.remove();J.$selected.remove();J.$wrapper.remove();J.$el.off(r.namespace).show().unwrap()}function x(L,K){if(typeof K!=="undefined"){var J=L.$items.index(L.$items.filter("[data-value="+K+"]"));L.$items.eq(J).addClass(u.item_disabled);L.$options.eq(J).prop("disabled",true)}else{if(L.$dropdown.hasClass(u.open)){L.$selected.trigger(r.click)}L.$dropdown.addClass(u.disabled);L.$el.prop("disabled",true);L.disabled=true}}function l(L,K){if(typeof K!=="undefined"){var J=L.$items.index(L.$items.filter("[data-value="+K+"]"));L.$items.eq(J).removeClass(u.item_disabled);L.$options.eq(J).prop("disabled",false)}else{L.$dropdown.removeClass(u.disabled);L.$el.prop("disabled",false);L.disabled=false}}function k(K){if(f.fn.fsScrollbar!==undefined){K.$wrapper.fsScrollbar("destroy")}var J=K.index;K.$allOptions=K.$el.find("option, optgroup");K.$options=K.$allOptions.filter("option");K.index=-1;J=K.$options.index(K.$options.filter(":selected"));D(K);if(!K.multiple){I(J,K)}if(f.fn.fsScrollbar!==undefined){K.$wrapper.fsScrollbar()}}function D(P){var R="",O=0;for(var Q=0,S=P.$allOptions.length;Q<S;Q++){var J=P.$allOptions.eq(Q),L=[];if(J[0].tagName==="OPTGROUP"){L.push(u.group);if(J.is(":disabled")){L.push(u.disabled)}R+='<span class="'+L.join(" ")+'">'+J.attr("label")+"</span>"}else{var N=J.val(),K=J.data("label"),M=(P.links)?"a":'button type="button"';if(!J.attr("value")){J.attr("value",N)}L.push(u.item);if(J.hasClass(u.item_placeholder)){L.push(u.item_placeholder);M="span"}if(J.is(":selected")){L.push(u.item_selected)}if(J.is(":disabled")){L.push(u.item_disabled)}R+="<"+M+' class="'+L.join(" ")+'"';if(P.links){if(M==="span"){R+=' aria-hidden="true"'}else{R+=' href="'+N+'"';if(P.external){R+=' target="_blank"'}}}else{R+=' data-value="'+N+'"'}R+=' role="option"';if(J.is(":selected")){R+=' "aria-selected"="true"'}R+=">";if(K){R+=K}else{R+=B.decodeEntities(H(J.text(),P.trim))}R+="</"+M+">";O++}}P.$items=P.$wrapper.html(f.parseHTML(R)).find(n.item)}function g(M){B.killEvent(M);var L=M.data;if(!L.disabled){if(!L.mobile&&s.isMobile&&!s.isFirefoxMobile&&!s.isIEMobile){var K=L.$el[0];if(z.createEvent){var J=z.createEvent("MouseEvents");J.initMouseEvent("mousedown",false,true,h,0,0,0,0,0,false,false,false,false,0,null);K.dispatchEvent(J)}else{if(K.fireEvent){K.fireEvent("onmousedown")}}}else{if(L.closed){E(L)}else{e(L)}}}m(L)}function m(J){f(n.base).not(J.$dropdown).trigger(r.close,[J])}function E(L){if(L.closed){var M=o.height(),K=L.$wrapper.outerHeight(true),J=L.$dropdown[0].getBoundingClientRect();if(J.bottom+K>M-L.bottomEdge){L.$dropdown.addClass(u.bottom)}F.on(r.click+L.dotGuid,":not("+n.options+")",L,c);L.$dropdown.trigger(r.focusIn);L.$dropdown.addClass(u.open);j(L);L.closed=false}}function e(J){if(J&&!J.closed){F.off(r.click+J.dotGuid);J.$dropdown.removeClass([u.open,u.bottom].join(" "));J.closed=true}}function c(K){B.killEvent(K);var J=K.data;if(J&&f(K.currentTarget).parents(n.base).length===0){e(J);J.$dropdown.trigger(r.focusOut)}}function d(K){var J=K.data;if(J){e(J);J.$dropdown.trigger(r.focusOut)}}function G(M){var J=f(this),L=M.data;B.killEvent(M);if(!L.disabled){var K=L.$items.index(J);L.focusIndex=K;if(L.$wrapper.is(":visible")){I(K,L,M.shiftKey,M.metaKey||M.ctrlKey);q(L)}if(!L.multiple){e(L)}L.$dropdown.trigger(r.focus)}}function C(N,K){var J=f(this),M=N.data;if(!K&&!M.multiple){var L=M.$options.index(M.$options.filter(":selected"));M.focusIndex=L;I(L,M);q(M,true)}}function a(L){B.killEvent(L);var J=f(L.currentTarget),K=L.data;if(!K.disabled&&!K.multiple&&!K.focused){m(K);K.focused=true;K.focusIndex=K.index;K.input="";K.$dropdown.addClass(u.focus).on(r.keyDown+K.dotGuid,K,i)}}function v(L){B.killEvent(L);var J=f(L.currentTarget),K=L.data;if(K.focused&&K.closed){K.focused=false;K.$dropdown.removeClass(u.focus).off(r.keyDown+K.dotGuid);if(!K.multiple){e(K);if(K.index!==K.focusIndex){q(K);K.focusIndex=K.index}}}}function i(P){var O=P.data;O.keyTimer=B.startTimer(O.keyTimer,1000,function(){O.input=""});if(P.keyCode===13){if(!O.closed){e(O);I(O.index,O)}q(O)}else{if(P.keyCode!==9&&(!P.metaKey&&!P.altKey&&!P.ctrlKey&&!P.shiftKey)){B.killEvent(P);var N=O.$items.length-1,L=(O.index<0)?0:O.index;if(f.inArray(P.keyCode,(s.isFirefox)?[38,40,37,39]:[38,40])>-1){L=L+((P.keyCode===38||(s.isFirefox&&P.keyCode===37))?-1:1);if(L<0){L=0}if(L>N){L=N}}else{var K=String.fromCharCode(P.keyCode).toUpperCase(),J,M;O.input+=K;for(M=O.index+1;M<=N;M++){J=O.$options.eq(M).text().substr(0,O.input.length).toUpperCase();if(J===O.input){L=M;break}}if(L<0||L===O.index){for(M=0;M<=N;M++){J=O.$options.eq(M).text().substr(0,O.input.length).toUpperCase();if(J===O.input){L=M;break}}}}if(L>=0){I(L,O);j(O)}}}}function I(O,N,Q,P){var S=N.$items.eq(O),J=N.$options.eq(O),L=S.hasClass(u.item_selected),T=S.hasClass(u.item_disabled);if(!T){if(N.multiple){if(s.isMobile){if(!T){if(L){J.prop("selected",null).attr("aria-selected",null);S.removeClass(u.item_selected)}else{J.prop("selected",true).attr("aria-selected",true);S.addClass(u.item_selected)}}}else{if(Q&&N.lastIndex!==false){var K=(N.lastIndex>O)?O:N.lastIndex,M=((N.lastIndex>O)?N.lastIndex:O)+1;N.$options.prop("selected",null).attr("aria-selected",null);N.$items.filter(n.item_selected).removeClass(u.item_selected);N.$options.slice(K,M).not("[disabled]").prop("selected",true);N.$items.slice(K,M).not(n.item_disabled).addClass(u.item_selected)}else{if(P){if(L){J.prop("selected",null).attr("aria-selected",null);S.removeClass(u.item_selected)}else{J.prop("selected",true).attr("aria-selected",true);S.addClass(u.item_selected)}N.lastIndex=O}else{N.$options.prop("selected",null).attr("aria-selected",null);N.$items.filter(n.item_selected).removeClass(u.item_selected);J.prop("selected",true).attr("aria-selected",true);S.addClass(u.item_selected);N.lastIndex=O}}}}else{if(O>-1&&O<N.$items.length){if(O!==N.index){var R=J.data("label")||S.html();N.$selected.html(R).removeClass(n.item_placeholder);N.$items.filter(n.item_selected).removeClass(u.item_selected);N.$el[0].selectedIndex=O;S.addClass(u.item_selected);N.index=O}}else{if(N.label!==""){N.$selected.html(N.label)}}}}}function j(L){var K=L.$items.eq(L.index),M=(L.index>=0&&!K.hasClass(u.item_placeholder))?K.position():{left:0,top:0},J=(L.$wrapper.outerHeight()-K.outerHeight())/2;if(f.fn.fsScrollbar!==undefined){L.$wrapper.fsScrollbar("resize").fsScrollbar("scroll",(L.$wrapper.find(".fs-scrollbar-content").scrollTop()+M.top))}else{L.$wrapper.scrollTop(L.$wrapper.scrollTop()+M.top-J)}}function q(J,K){if(J.links){p(J)}else{if(!K){J.$el.trigger(r.raw.change,[true])}}}function p(K){var J=K.$el.val();if(K.external){h.open(J)}else{h.location.href=J}}function H(K,J){if(J===0){return K}else{if(K.length>J){return K.substring(0,J)+"..."}else{return K}}}function A(J){return(typeof J==="string")?J.replace(/([;&,\.\+\*\~':"\!\^#$%@\[\]\(\)=>\|])/g,"\\$1"):J}var b=s.Plugin("dropdown",{widget:true,defaults:{bottomEdge:0,cover:false,customClass:"",label:"",external:false,links:false,mobile:false,theme:"fs-light",trim:0},methods:{_setup:y,_construct:w,_destruct:t,disable:x,enable:l,update:k,open:E,close:e},classes:["cover","bottom","multiple","mobile","open","disabled","focus","selected","options","group","item","item_disabled","item_selected","item_placeholder"],events:{close:"close"}}),n=b.classes,u=n.raw,r=b.events,B=b.functions,h=s.window,o=s.$window,z=s.document,F=null}));