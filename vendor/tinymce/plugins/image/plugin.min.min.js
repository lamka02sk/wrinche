tinymce.PluginManager.add("image",function(d){function b(k,h){function l(i,m){j.parentNode&&j.parentNode.removeChild(j),h({width:i,height:m})}var j=document.createElement("img");j.onload=function(){l(Math.max(j.width,j.clientWidth),Math.max(j.height,j.clientHeight))},j.onerror=function(){l()};var g=j.style;g.visibility="hidden",g.position="fixed",g.bottom=g.left=0,g.width=g.height="auto",document.body.appendChild(j),j.src=k}function f(i,g,j){function h(k,l){return l=l||[],tinymce.each(k,function(n){var m={text:n.text||n.title};n.menu?m.menu=h(n.menu):(m.value=n.value,g(m)),l.push(m)}),l}return h(i,j||[])}function c(e){return function(){var g=d.settings.image_list;"string"==typeof g?tinymce.util.XHR.send({url:g,success:function(h){e(tinymce.util.JSON.parse(h))}}):"function"==typeof g?g(e):e(g)}}function a(A){function G(){var i,g,l,h;i=J.find("#width")[0],g=J.find("#height")[0],i&&g&&(l=i.value(),h=g.value(),J.find("#constrain")[0].checked()&&E&&I&&l&&h&&(E!=l?(h=Math.round(l/E*h),isNaN(h)||g.value(h)):(l=Math.round(h/I*l),isNaN(l)||i.value(l))),E=l,I=h)}function D(){function g(l){function m(){l.onload=l.onerror=null,d.selection&&(d.selection.select(l),d.nodeChanged())}l.onload=function(){M.width||M.height||!j||z.setAttribs(l,{width:l.clientWidth,height:l.clientHeight}),m()},l.onerror=m}var i,h;L(),G(),M=tinymce.extend(M,J.toJSON()),M.alt||(M.alt=""),M.title||(M.title=""),""===M.width&&(M.width=null),""===M.height&&(M.height=null),M.style||(M.style=null),M={src:M.src,alt:M.alt,title:M.title,width:M.width,height:M.height,style:M.style,caption:M.caption,"class":M["class"]},d.undoManager.transact(function(){function l(o){return d.schema.getTextBlockElements()[o.nodeName]}if(!M.src){return void (B&&(z.remove(B),d.focus(),d.nodeChanged()))}if(""===M.title&&(M.title=null),B?z.setAttribs(B,M):(M.id="__mcenew",d.focus(),d.selection.setContent(z.createHTML("img",M)),B=z.get("__mcenew"),z.setAttrib(B,"id",null)),d.editorUpload.uploadImagesAuto(),M.caption===!1&&z.is(B.parentNode,"figure.image")&&(i=B.parentNode,z.insertAfter(B,i),z.remove(i)),M.caption!==!0){g(B)}else{if(!z.is(B.parentNode,"figure.image")){h=B,B=B.cloneNode(!0),i=z.create("figure",{"class":"image"}),i.appendChild(B),i.appendChild(z.create("figcaption",{contentEditable:!0},"Caption")),i.contentEditable=!1;var m=z.getParent(h,l);m?z.split(m,h,i):z.replace(i,h),d.selection.select(i)}}})}function N(g){return g&&(g=g.replace(/px$/,"")),g}function t(p){var l,h,m,g=p.meta||{};n&&n.value(d.convertURL(this.value(),"src")),tinymce.each(g,function(o,i){J.find("#"+i).value(o)}),g.width||g.height||(l=d.convertURL(this.value(),"src"),h=d.settings.image_prepend_url,m=new RegExp("^(?:[a-z]+:)?//","i"),h&&!m.test(l)&&l.substring(0,h.length)!==h&&(l=h+l),this.value(l),b(d.documentBaseURI.toAbsolute(this.value()),function(i){i.width&&i.height&&j&&(E=i.width,I=i.height,J.find("#width").value(E),J.find("#height").value(I))}))}function F(g){g.meta=J.toJSON()}function q(h){if(h.margin){var g=h.margin.split(" ");switch(g.length){case 1:h["margin-top"]=h["margin-top"]||g[0],h["margin-right"]=h["margin-right"]||g[0],h["margin-bottom"]=h["margin-bottom"]||g[0],h["margin-left"]=h["margin-left"]||g[0];break;case 2:h["margin-top"]=h["margin-top"]||g[0],h["margin-right"]=h["margin-right"]||g[1],h["margin-bottom"]=h["margin-bottom"]||g[0],h["margin-left"]=h["margin-left"]||g[1];break;case 3:h["margin-top"]=h["margin-top"]||g[0],h["margin-right"]=h["margin-right"]||g[1],h["margin-bottom"]=h["margin-bottom"]||g[2],h["margin-left"]=h["margin-left"]||g[1];break;case 4:h["margin-top"]=h["margin-top"]||g[0],h["margin-right"]=h["margin-right"]||g[1],h["margin-bottom"]=h["margin-bottom"]||g[2],h["margin-left"]=h["margin-left"]||g[3]}delete h.margin}return h}function L(){function g(l){return l.length>0&&/^[0-9]+$/.test(l)&&(l+="px"),l}if(d.settings.image_advtab){var i=J.toJSON(),h=z.parseStyle(i.style);h=q(h),i.vspace&&(h["margin-top"]=h["margin-bottom"]=g(i.vspace)),i.hspace&&(h["margin-left"]=h["margin-right"]=g(i.hspace)),i.border&&(h["border-width"]=g(i.border)),J.find("#style").value(z.serializeStyle(z.parseStyle(z.serializeStyle(h))))}}function K(){if(d.settings.image_advtab){var g=J.toJSON(),h=z.parseStyle(g.style);J.find("#vspace").value(""),J.find("#hspace").value(""),h=q(h),(h["margin-top"]&&h["margin-bottom"]||h["margin-right"]&&h["margin-left"])&&(h["margin-top"]===h["margin-bottom"]?J.find("#vspace").value(N(h["margin-top"])):J.find("#vspace").value(""),h["margin-right"]===h["margin-left"]?J.find("#hspace").value(N(h["margin-right"])):J.find("#hspace").value("")),h["border-width"]&&J.find("#border").value(N(h["border-width"])),J.find("#style").value(z.serializeStyle(z.parseStyle(z.serializeStyle(h))))}}var J,B,H,E,I,n,e,M={},z=d.dom,j=d.settings.image_dimensions!==!1;B=d.selection.getNode(),H=z.getParent(B,"figure.image"),H&&(B=z.select("img",H)[0]),B&&("IMG"!=B.nodeName||B.getAttribute("data-mce-object")||B.getAttribute("data-mce-placeholder"))&&(B=null),B&&(E=z.getAttrib(B,"width"),I=z.getAttrib(B,"height"),M={src:z.getAttrib(B,"src"),alt:z.getAttrib(B,"alt"),title:z.getAttrib(B,"title"),"class":z.getAttrib(B,"class"),width:E,height:I,caption:!!H}),A&&(n={type:"listbox",label:"Image list",values:f(A,function(g){g.value=d.convertURL(g.value||g.url,"src")},[{text:"None",value:""}]),value:M.src&&d.convertURL(M.src,"src"),onselect:function(h){var g=J.find("#alt");(!g.value()||h.lastControl&&g.value()==h.lastControl.text())&&g.value(h.control.text()),J.find("#src").value(h.control.value()).fire("change")},onPostRender:function(){n=this}}),d.settings.image_class_list&&(e={name:"class",type:"listbox",label:"Class",values:f(d.settings.image_class_list,function(g){g.value&&(g.textStyle=function(){return d.formatter.getCssText({inline:"img",classes:[g.value]})})})});var k=[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:!0,onchange:t,onbeforecall:F},n];d.settings.image_description!==!1&&k.push({name:"alt",type:"textbox",label:"Image description"}),d.settings.image_title&&k.push({name:"title",type:"textbox",label:"Image Title"}),j&&k.push({type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:G,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:G,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}),k.push(e),d.settings.image_caption&&tinymce.Env.ceFalse&&k.push({name:"caption",type:"checkbox",label:"Caption"}),d.settings.image_advtab?(B&&(B.style.marginLeft&&B.style.marginRight&&B.style.marginLeft===B.style.marginRight&&(M.hspace=N(B.style.marginLeft)),B.style.marginTop&&B.style.marginBottom&&B.style.marginTop===B.style.marginBottom&&(M.vspace=N(B.style.marginTop)),B.style.borderWidth&&(M.border=N(B.style.borderWidth)),M.style=d.dom.serializeStyle(d.dom.parseStyle(d.dom.getAttrib(B,"style")))),J=d.windowManager.open({title:"Insert/edit image",data:M,bodyType:"tabpanel",body:[{title:"General",type:"form",items:k},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox",onchange:K},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:L},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:D})):J=d.windowManager.open({title:"Insert/edit image",data:M,body:k,onSubmit:D})}d.on("preInit",function(){function e(i){var h=i.attr("class");return h&&/\bimage\b/.test(h)}function g(h){return function(m){function k(i){i.attr("contenteditable",h?"true":null)}for(var j,l=m.length;l--;){j=m[l],e(j)&&(j.attr("contenteditable",h?"false":null),tinymce.each(j.getAll("figcaption"),k))}}}d.parser.addNodeFilter("figure",g(!0)),d.serializer.addNodeFilter("figure",g(!1))}),d.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:c(a),stateSelector:"img:not([data-mce-object],[data-mce-placeholder]),figure.image"}),d.addMenuItem("image",{icon:"image",text:"Image",onclick:c(a),context:"insert",prependToContext:!0}),d.addCommand("mceImage",c(a))});