tinymce.PluginManager.add("image",function(i){function e(b,d){function a(l,k){c.parentNode&&c.parentNode.removeChild(c),d({width:l,height:k})}var c=document.createElement("img");c.onload=function(){a(Math.max(c.width,c.clientWidth),Math.max(c.height,c.clientHeight))},c.onerror=function(){a()};var f=c.style;f.visibility="hidden",f.position="fixed",f.bottom=f.left=0,f.width=f.height="auto",document.body.appendChild(c),c.src=b}function h(b,d,a){function c(m,f){return f=f||[],tinymce.each(m,function(l){var k={text:l.text||l.title};l.menu?k.menu=c(l.menu):(k.value=l.value,d(k)),f.push(k)}),f}return c(b,a||[])}function j(a){return function(){var b=i.settings.image_list;"string"==typeof b?tinymce.util.XHR.send({url:b,success:function(c){a(tinymce.util.JSON.parse(c))}}):"function"==typeof b?b(a):a(b)}}function g(y){function p(){var n,t,k,q;n=l.find("#width")[0],t=l.find("#height")[0],n&&t&&(k=n.value(),q=t.value(),l.find("#constrain")[0].checked()&&s&&m&&k&&q&&(s!=k?(q=Math.round(k/s*q),isNaN(q)||t.value(q)):(k=Math.round(q/m*k),isNaN(k)||n.value(k))),s=k,m=q)}function v(){function q(z){function t(){z.onload=z.onerror=null,i.selection&&(i.selection.select(z),i.nodeChanged())}z.onload=function(){b.width||b.height||!P||d.setAttribs(z,{width:z.clientWidth,height:z.clientHeight}),t()},z.onerror=t}var k,n;c(),p(),b=tinymce.extend(b,l.toJSON()),b.alt||(b.alt=""),b.title||(b.title=""),""===b.width&&(b.width=null),""===b.height&&(b.height=null),b.style||(b.style=null),b={src:b.src,alt:b.alt,title:b.title,width:b.width,height:b.height,style:b.style,caption:b.caption,"class":b["class"]},i.undoManager.transact(function(){function z(A){return i.schema.getTextBlockElements()[A.nodeName]}if(!b.src){return void (w&&(d.remove(w),i.focus(),i.nodeChanged()))}if(""===b.title&&(b.title=null),w?d.setAttribs(w,b):(b.id="__mcenew",i.focus(),i.selection.setContent(d.createHTML("img",b)),w=d.get("__mcenew"),d.setAttrib(w,"id",null)),i.editorUpload.uploadImagesAuto(),b.caption===!1&&d.is(w.parentNode,"figure.image")&&(k=w.parentNode,d.insertAfter(w,k),d.remove(k)),b.caption!==!0){q(w)}else{if(!d.is(w.parentNode,"figure.image")){n=w,w=w.cloneNode(!0),k=d.create("figure",{"class":"image"}),k.appendChild(w),k.appendChild(d.create("figcaption",{contentEditable:!0},"Caption")),k.contentEditable=!1;var t=d.getParent(n,z);t?d.split(t,n,k):d.replace(k,n),i.selection.select(k)}}})}function a(k){return k&&(k=k.replace(/px$/,"")),k}function u(z){var n,q,k,t=z.meta||{};C&&C.value(i.convertURL(this.value(),"src")),tinymce.each(t,function(B,A){l.find("#"+A).value(B)}),t.width||t.height||(n=i.convertURL(this.value(),"src"),q=i.settings.image_prepend_url,k=new RegExp("^(?:[a-z]+:)?//","i"),q&&!k.test(n)&&n.substring(0,q.length)!==q&&(n=q+n),this.value(n),e(i.documentBaseURI.toAbsolute(this.value()),function(A){A.width&&A.height&&P&&(s=A.width,m=A.height,l.find("#width").value(s),l.find("#height").value(m))}))}function r(k){k.meta=l.toJSON()}function x(k){if(k.margin){var n=k.margin.split(" ");switch(n.length){case 1:k["margin-top"]=k["margin-top"]||n[0],k["margin-right"]=k["margin-right"]||n[0],k["margin-bottom"]=k["margin-bottom"]||n[0],k["margin-left"]=k["margin-left"]||n[0];break;case 2:k["margin-top"]=k["margin-top"]||n[0],k["margin-right"]=k["margin-right"]||n[1],k["margin-bottom"]=k["margin-bottom"]||n[0],k["margin-left"]=k["margin-left"]||n[1];break;case 3:k["margin-top"]=k["margin-top"]||n[0],k["margin-right"]=k["margin-right"]||n[1],k["margin-bottom"]=k["margin-bottom"]||n[2],k["margin-left"]=k["margin-left"]||n[1];break;case 4:k["margin-top"]=k["margin-top"]||n[0],k["margin-right"]=k["margin-right"]||n[1],k["margin-bottom"]=k["margin-bottom"]||n[2],k["margin-left"]=k["margin-left"]||n[3]}delete k.margin}return k}function c(){function q(t){return t.length>0&&/^[0-9]+$/.test(t)&&(t+="px"),t}if(i.settings.image_advtab){var k=l.toJSON(),n=d.parseStyle(k.style);n=x(n),k.vspace&&(n["margin-top"]=n["margin-bottom"]=q(k.vspace)),k.hspace&&(n["margin-left"]=n["margin-right"]=q(k.hspace)),k.border&&(n["border-width"]=q(k.border)),l.find("#style").value(d.serializeStyle(d.parseStyle(d.serializeStyle(n))))}}function f(){if(i.settings.image_advtab){var n=l.toJSON(),k=d.parseStyle(n.style);l.find("#vspace").value(""),l.find("#hspace").value(""),k=x(k),(k["margin-top"]&&k["margin-bottom"]||k["margin-right"]&&k["margin-left"])&&(k["margin-top"]===k["margin-bottom"]?l.find("#vspace").value(a(k["margin-top"])):l.find("#vspace").value(""),k["margin-right"]===k["margin-left"]?l.find("#hspace").value(a(k["margin-right"])):l.find("#hspace").value("")),k["border-width"]&&l.find("#border").value(a(k["border-width"])),l.find("#style").value(d.serializeStyle(d.parseStyle(d.serializeStyle(k))))}}var l,w,o,s,m,C,Q,b={},d=i.dom,P=i.settings.image_dimensions!==!1;w=i.selection.getNode(),o=d.getParent(w,"figure.image"),o&&(w=d.select("img",o)[0]),w&&("IMG"!=w.nodeName||w.getAttribute("data-mce-object")||w.getAttribute("data-mce-placeholder"))&&(w=null),w&&(s=d.getAttrib(w,"width"),m=d.getAttrib(w,"height"),b={src:d.getAttrib(w,"src"),alt:d.getAttrib(w,"alt"),title:d.getAttrib(w,"title"),"class":d.getAttrib(w,"class"),width:s,height:m,caption:!!o}),y&&(C={type:"listbox",label:"Image list",values:h(y,function(k){k.value=i.convertURL(k.value||k.url,"src")},[{text:"None",value:""}]),value:b.src&&i.convertURL(b.src,"src"),onselect:function(k){var n=l.find("#alt");(!n.value()||k.lastControl&&n.value()==k.lastControl.text())&&n.value(k.control.text()),l.find("#src").value(k.control.value()).fire("change")},onPostRender:function(){C=this}}),i.settings.image_class_list&&(Q={name:"class",type:"listbox",label:"Class",values:h(i.settings.image_class_list,function(k){k.value&&(k.textStyle=function(){return i.formatter.getCssText({inline:"img",classes:[k.value]})})})});var O=[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:!0,onchange:u,onbeforecall:r},C];i.settings.image_description!==!1&&O.push({name:"alt",type:"textbox",label:"Image description"}),i.settings.image_title&&O.push({name:"title",type:"textbox",label:"Image Title"}),P&&O.push({type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:p,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:p,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}),O.push(Q),i.settings.image_caption&&tinymce.Env.ceFalse&&O.push({name:"caption",type:"checkbox",label:"Caption"}),i.settings.image_advtab?(w&&(w.style.marginLeft&&w.style.marginRight&&w.style.marginLeft===w.style.marginRight&&(b.hspace=a(w.style.marginLeft)),w.style.marginTop&&w.style.marginBottom&&w.style.marginTop===w.style.marginBottom&&(b.vspace=a(w.style.marginTop)),w.style.borderWidth&&(b.border=a(w.style.borderWidth)),b.style=i.dom.serializeStyle(i.dom.parseStyle(i.dom.getAttrib(w,"style")))),l=i.windowManager.open({title:"Insert/edit image",data:b,bodyType:"tabpanel",body:[{title:"General",type:"form",items:O},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox",onchange:f},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:c},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:v})):l=i.windowManager.open({title:"Insert/edit image",data:b,body:O,onSubmit:v})}i.on("preInit",function(){function b(c){var d=c.attr("class");return d&&/\bimage\b/.test(d)}function a(c){return function(d){function n(k){k.attr("contenteditable",c?"true":null)}for(var o,f=d.length;f--;){o=d[f],b(o)&&(o.attr("contenteditable",c?"false":null),tinymce.each(o.getAll("figcaption"),n))}}}i.parser.addNodeFilter("figure",a(!0)),i.serializer.addNodeFilter("figure",a(!1))}),i.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:j(g),stateSelector:"img:not([data-mce-object],[data-mce-placeholder]),figure.image"}),i.addMenuItem("image",{icon:"image",text:"Image",onclick:j(g),context:"insert",prependToContext:!0}),i.addCommand("mceImage",j(g))});