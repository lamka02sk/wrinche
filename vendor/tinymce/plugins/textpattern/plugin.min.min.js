tinymce.PluginManager.add("textpattern",function(h){function m(){return k&&(f.sort(function(i,a){return i.start.length>a.start.length?-1:i.start.length<a.start.length?1:0}),k=!1),f}function d(i){for(var l=m(),a=0;a<l.length;a++){if(0===i.indexOf(l[a].start)&&(!l[a].end||i.lastIndexOf(l[a].end)==i.length-l[a].end.length)){return l[a]}}}function b(t,v,s){var q,u,l;for(q=m(),l=0;l<q.length;l++){if(u=q[l],u.end&&t.substr(v-u.end.length-s,u.end.length)==u.end){return u}}}function g(C){function v(){r=r.splitText(z),r.splitText(B-z-w),r.deleteData(0,e.start.length),r.deleteData(r.data.length-e.end.length,e.end.length)}var n,A,D,r,B,z,y,x,e,w,q;if(n=h.selection,A=h.dom,n.isCollapsed()&&(D=n.getRng(!0),r=D.startContainer,B=D.startOffset,y=r.data,w=C?1:0,3==r.nodeType&&(e=b(y,B,w),e&&(z=Math.max(0,B-w),z=y.lastIndexOf(e.start,z-e.end.length-1),z!==-1&&(x=A.createRng(),x.setStart(r,z),x.setEnd(r,B-w),e=d(x.toString()),e&&e.end&&!(r.data.length<=e.start.length+e.end.length)))))){return q=h.formatter.get(e.format),q&&q[0].inline?(v(),h.formatter.apply(e.format,{},r),r):void 0}}function c(){var B,e,v,n,z,C,q,A,y,x,w;if(B=h.selection,e=h.dom,B.isCollapsed()&&(q=e.getParent(B.getStart(),"p"))){for(y=new tinymce.dom.TreeWalker(q,q);z=y.next();){if(3==z.nodeType){n=z;break}}if(n){if(A=d(n.data),!A){return}if(x=B.getRng(!0),v=x.startContainer,w=x.startOffset,n==v&&(w=Math.max(0,w-A.start.length)),tinymce.trim(n.data).length==A.start.length){return}A.format&&(C=h.formatter.get(A.format),C&&C[0].block&&(n.deleteData(0,A.start.length),h.formatter.apply(A.format,{},n),x.setStart(v,w),x.collapse(!0),B.setRng(x))),A.cmd&&h.undoManager.transact(function(){n.deleteData(0,A.start.length),h.execCommand(A.cmd)})}}}function j(){var a,e;e=g(),e&&(a=h.dom.createRng(),a.setStart(e,e.data.length),a.setEnd(e,e.data.length),h.selection.setRng(a)),c()}function p(){var i,s,l,q,e;i=g(!0),i&&(e=h.dom,s=i.data.slice(-1),/[\u00a0 ]/.test(s)&&(i.deleteData(i.data.length-1,1),l=e.doc.createTextNode(s),i.nextSibling?e.insertAfter(l,i.nextSibling):i.parentNode.appendChild(l),q=e.createRng(),q.setStart(l,1),q.setEnd(l,1),h.selection.setRng(q)))}var f,k=!0;f=h.settings.textpattern_patterns||[{start:"*",end:"*",format:"italic"},{start:"**",end:"**",format:"bold"},{start:"#",format:"h1"},{start:"##",format:"h2"},{start:"###",format:"h3"},{start:"####",format:"h4"},{start:"#####",format:"h5"},{start:"######",format:"h6"},{start:"1. ",cmd:"InsertOrderedList"},{start:"* ",cmd:"InsertUnorderedList"},{start:"- ",cmd:"InsertUnorderedList"}],h.on("keydown",function(a){13!=a.keyCode||tinymce.util.VK.modifierPressed(a)||j()},!0),h.on("keyup",function(a){32!=a.keyCode||tinymce.util.VK.modifierPressed(a)||p()}),this.getPatterns=m,this.setPatterns=function(a){f=a,k=!0}});