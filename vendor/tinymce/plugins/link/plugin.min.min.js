tinymce.PluginManager.add("link",function(G){function k(a){return a&&"A"===a.nodeName&&a.href}function z(a){return tinymce.util.Tools.grep(a,k).length>0}function w(a){return G.dom.getParent(a,"a[href]")}function C(){return w(G.selection.getStart())}function y(c){var a=c.getAttribute("data-mce-href");return a?a:c.getAttribute("href")}function J(){var a=G.plugins.contextmenu;return !!a&&a.isContextMenuVisible()}function q(e){var c,a,d;return !!(G.settings.link_context_toolbar&&!J()&&k(e)&&(c=G.selection,a=c.getRng(),d=a.startContainer,3==d.nodeType&&c.isCollapsed()&&a.startOffset>0&&a.startOffset<d.data.length))}function B(c,a){document.body.appendChild(c),c.dispatchEvent(a),document.body.removeChild(c)}function j(f){if(!tinymce.Env.ie||tinymce.Env.ie>10){var c=document.createElement("a");c.target="_blank",c.href=f,c.rel="noreferrer noopener";var g=document.createEvent("MouseEvents");g.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),B(c,g)}else{var d=window.open("","_blank");if(d){d.opener=null;var a=d.document;a.open(),a.write('<meta http-equiv="refresh" content="0; url='+tinymce.DOM.encode(f)+'">'),a.close()}}}function I(a){if(a){var d=y(a);if(/^#/.test(d)){var c=G.$(d);c.length&&G.selection.scrollIntoView(c[0],!0)}else{j(a.href)}}}function H(){I(C())}function F(){var a=this,c=function(d){z(d.parents)?a.show():a.hide()};z(G.dom.getParents(G.selection.getStart()))||a.hide(),G.on("nodechange",c),a.on("remove",function(){G.off("nodechange",c)})}function x(a){return function(){var c=G.settings.link_list;"string"==typeof c?tinymce.util.XHR.send({url:c,success:function(d){a(tinymce.util.JSON.parse(d))}}):"function"==typeof c?c(a):a(c)}}function D(d,a,f){function c(g,h){return h=h||[],tinymce.each(g,function(m){var l={text:m.text||m.title};m.menu?l.menu=c(m.menu):(l.value=m.value,a&&a(l)),h.push(l)}),h}return c(d,f||[])}function A(P){function V(c){var a=aa.find("#text");(!a.value()||c.lastControl&&a.value()==c.lastControl.text())&&a.value(c.control.text()),aa.find("#href").value(c.control.value())}function S(a){var c=[];if(tinymce.each(G.dom.select("a:not([href])"),function(d){var f=d.name||d.id;f&&c.push({text:f,value:"#"+f,selected:a.indexOf("#"+f)!=-1})}),c.length){return c.unshift({text:"None",value:""}),{name:"anchor",type:"listbox",label:"Anchors",values:c,onselect:V}}}function Y(){!ab&&0===K.text.length&&Z&&this.parent().parent().find("#text")[0].value(this.value())}function U(a){var c=a.meta||{};W&&W.value(G.convertURL(this.value(),"href")),tinymce.each(a.meta,function(f,d){var i=aa.find("#"+d);"text"===d?0===ab.length&&(i.value(f),K.text=f):i.value(f)}),c.attach&&(E={href:this.value(),attach:c.attach}),c.text||Y.call(this)}function ad(d){var a=O.getContent();if(/</.test(a)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(a)||a.indexOf("href=")==-1)){return !1}if(d){var f,c=d.childNodes;if(0===c.length){return !1}for(f=c.length-1;f>=0;f--){if(3!=c[f].nodeType){return !1}}}return !0}function Q(a){a.meta=aa.toJSON()}var X,M,ab,aa,Z,T,W,L,g,ac,R,h,K={},O=G.selection,e=G.dom;X=O.getNode(),M=e.getParent(X,"a[href]"),Z=ad(),K.text=ab=M?M.innerText||M.textContent:O.getContent({format:"text"}),K.href=M?e.getAttrib(M,"href"):"",M?K.target=e.getAttrib(M,"target"):G.settings.default_link_target&&(K.target=G.settings.default_link_target),(h=e.getAttrib(M,"rel"))&&(K.rel=h),(h=e.getAttrib(M,"class"))&&(K["class"]=h),(h=e.getAttrib(M,"title"))&&(K.title=h),Z&&(T={name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){K.text=this.value()}}),P&&(W={type:"listbox",label:"Link list",values:D(P,function(a){a.value=G.convertURL(a.value||a.url,"href")},[{text:"None",value:""}]),onselect:V,value:G.convertURL(K.href,"href"),onPostRender:function(){W=this}}),G.settings.target_list!==!1&&(G.settings.target_list||(G.settings.target_list=[{text:"None",value:""},{text:"New window",value:"_blank"}]),g={name:"target",type:"listbox",label:"Target",values:D(G.settings.target_list)}),G.settings.rel_list&&(L={name:"rel",type:"listbox",label:"Rel",values:D(G.settings.rel_list)}),G.settings.link_class_list&&(ac={name:"class",type:"listbox",label:"Class",values:D(G.settings.link_class_list,function(a){a.value&&(a.textStyle=function(){return G.formatter.getCssText({inline:"a",classes:[a.value]})})})}),G.settings.link_title!==!1&&(R={name:"title",type:"textbox",label:"Title",value:K.title}),aa=G.windowManager.open({title:"Insert link",data:K,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:!0,label:"Url",onchange:U,onkeyup:Y,onbeforecall:Q},T,R,S(K.href),W,L,g,ac],onSubmit:function(f){function p(a,o){var i=G.selection.getRng();tinymce.util.Delay.setEditorTimeout(G,function(){G.windowManager.confirm(a,function(n){G.selection.setRng(i),o(n)})})}function l(u,o){function v(i){return i=s(i),i?[i,a].join(" "):a}function s(n){var i=new RegExp("("+a.replace(" ","|")+")","g");return n&&(n=tinymce.trim(n.replace(i,""))),n?n:null}var a="noopener noreferrer";return o?v(u):s(u)}function d(){var a={href:c,target:K.target?K.target:null,rel:K.rel?K.rel:null,"class":K["class"]?K["class"]:null,title:K.title?K.title:null};G.settings.allow_unsafe_link_target||(a.rel=l(a.rel,"_blank"==a.target)),c===E.href&&(E.attach(),E={}),M?(G.focus(),Z&&K.text!=ab&&("innerText" in M?M.innerText=K.text:M.textContent=K.text),e.setAttribs(M,a),O.select(M),G.undoManager.add()):Z?G.insertContent(e.createHTML("a",a,e.encode(K.text))):G.execCommand("mceInsertLink",!1,a)}function m(){G.undoManager.transact(d)}var c;return K=tinymce.extend(K,f.data),(c=K.href)?c.indexOf("@")>0&&c.indexOf("//")==-1&&c.indexOf("mailto:")==-1?void p("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(a){a&&(c="mailto:"+c),m()}):G.settings.link_assume_external_targets&&!/^\w+:/i.test(c)||!G.settings.link_assume_external_targets&&/^\s*www[\.|\d\.]/i.test(c)?void p("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",function(a){a&&(c="http://"+c),m()}):void m():void G.execCommand("unlink")}})}var E={},b=function(a){return a.altKey===!0&&a.shiftKey===!1&&a.ctrlKey===!1&&a.metaKey===!1};G.addButton("link",{icon:"link",tooltip:"Insert/edit link",shortcut:"Meta+K",onclick:x(A),stateSelector:"a[href]"}),G.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink",stateSelector:"a[href]"}),G.addContextToolbar&&(G.addButton("openlink",{icon:"newtab",tooltip:"Open link",onclick:H}),G.addContextToolbar(q,"openlink | link unlink")),G.addShortcut("Meta+K","",x(A)),G.addCommand("mceLink",x(A)),G.on("click",function(c){var a=w(c.target);a&&tinymce.util.VK.metaKeyPressed(c)&&(c.preventDefault(),I(a))}),G.on("keydown",function(c){var a=C();a&&13===c.keyCode&&b(c)&&(c.preventDefault(),I(a))}),this.showDialog=A,G.addMenuItem("openlink",{text:"Open link",icon:"newtab",onclick:H,onPostRender:F,prependToContext:!0}),G.addMenuItem("link",{icon:"link",text:"Link",shortcut:"Meta+K",onclick:x(A),stateSelector:"a[href]",context:"insert",prependToContext:!0})});