tinymce.PluginManager.add("fullpage",function(k){function w(){var a=g();k.windowManager.open({title:"Document properties",data:a,defaults:{type:"textbox",size:40},body:[{name:"title",label:"Title"},{name:"keywords",label:"Keywords"},{name:"description",label:"Description"},{name:"robots",label:"Robots"},{name:"author",label:"Author"},{name:"docencoding",label:"Encoding"}],onSubmit:function(c){b(tinymce.extend(a,c.data))}})}function g(){function d(o,a){var r=o.attr(a);return r||""}var l,e,i=j(),c={};return c.fontface=k.getParam("fullpage_default_fontface",""),c.fontsize=k.getParam("fullpage_default_fontsize",""),l=i.firstChild,7==l.type&&(c.xml_pi=!0,e=/encoding="([^"]+)"/.exec(l.value),e&&(c.docencoding=e[1])),l=i.getAll("#doctype")[0],l&&(c.doctype="<!DOCTYPE"+l.value+">"),l=i.getAll("title")[0],l&&l.firstChild&&(c.title=l.firstChild.value),p(i.getAll("meta"),function(s){var a,u=s.attr("name"),o=s.attr("http-equiv");u?c[u.toLowerCase()]=s.attr("content"):"Content-Type"==o&&(a=/charset\s*=\s*(.*)\s*/gi.exec(s.attr("content")),a&&(c.docencoding=a[1]))}),l=i.getAll("html")[0],l&&(c.langcode=d(l,"lang")||d(l,"xml:lang")),c.stylesheets=[],tinymce.each(i.getAll("link"),function(a){"stylesheet"==a.attr("rel")&&c.stylesheets.push(a.attr("href"))}),l=i.getAll("body")[0],l&&(c.langdir=d(l,"dir"),c.style=d(l,"style"),c.visited_color=d(l,"vlink"),c.link_color=d(l,"link"),c.active_color=d(l,"alink")),c}function b(B){function i(o,a,r){o.attr(a,r?r:void 0)}function c(a){z.firstChild?z.insert(a,z.firstChild):z.append(a)}var e,z,C,A,y,d=k.dom;e=j(),z=e.getAll("head")[0],z||(A=e.getAll("html")[0],z=new m("head",1),A.firstChild?A.insert(z,A.firstChild,!0):A.append(z)),A=e.firstChild,B.xml_pi?(y='version="1.0"',B.docencoding&&(y+=' encoding="'+B.docencoding+'"'),7!=A.type&&(A=new m("xml",7),e.insert(A,e.firstChild,!0)),A.value=y):A&&7==A.type&&A.remove(),A=e.getAll("#doctype")[0],B.doctype?(A||(A=new m("#doctype",10),B.xml_pi?e.insert(A,e.firstChild):c(A)),A.value=B.doctype.substring(9,B.doctype.length-1)):A&&A.remove(),A=null,p(e.getAll("meta"),function(a){"Content-Type"==a.attr("http-equiv")&&(A=a)}),B.docencoding?(A||(A=new m("meta",1),A.attr("http-equiv","Content-Type"),A.shortEnded=!0,c(A)),A.attr("content","text/html; charset="+B.docencoding)):A&&A.remove(),A=e.getAll("title")[0],B.title?(A?A.empty():(A=new m("title",1),c(A)),A.append(new m("#text",3)).value=B.title):A&&A.remove(),p("keywords,description,author,copyright,robots".split(","),function(u){var D,r,o=e.getAll("meta"),t=B[u];for(D=0;D<o.length;D++){if(r=o[D],r.attr("name")==u){return void (t?r.attr("content",t):r.remove())}}t&&(A=new m("meta",1),A.attr("name",u),A.attr("content",t),A.shortEnded=!0,c(A))});var l={};tinymce.each(e.getAll("link"),function(a){"stylesheet"==a.attr("rel")&&(l[a.attr("href")]=a)}),tinymce.each(B.stylesheets,function(a){l[a]||(A=new m("link",1),A.attr({rel:"stylesheet",text:"text/css",href:a}),A.shortEnded=!0,c(A)),delete l[a]}),tinymce.each(l,function(a){a.remove()}),A=e.getAll("body")[0],A&&(i(A,"dir",B.langdir),i(A,"style",B.style),i(A,"vlink",B.visited_color),i(A,"link",B.link_color),i(A,"alink",B.active_color),d.setAttribs(k.getBody(),{style:B.style,dir:B.dir,vLink:B.visited_color,link:B.link_color,aLink:B.active_color})),A=e.getAll("html")[0],A&&(i(A,"lang",B.langcode),i(A,"xml:lang",B.langcode)),z.firstChild||z.remove(),C=new tinymce.html.Serializer({validate:!1,indent:!0,apply_source_formatting:!0,indent_before:"head,html,body,meta,title,script,link,style",indent_after:"head,html,body,meta,title,script,link,style"}).serialize(e),h=C.substring(0,C.indexOf("</body>"))}function j(){return new tinymce.html.DomParser({validate:!1,root_name:"#document"}).parse(h)}function f(B){function i(d){return d.replace(/<\/?[A-Z]+/g,function(n){return n.toLowerCase()})}var a,e,C,A,z=B.content,c="",u=k.dom;if(!B.selection&&!("raw"==B.format&&h||B.source_view&&k.getParam("fullpage_hide_in_source_view"))){0!==z.length||B.source_view||(z=tinymce.trim(h)+"\n"+tinymce.trim(z)+"\n"+tinymce.trim(v)),z=z.replace(/<(\/?)BODY/gi,"<$1body"),a=z.indexOf("<body"),a!=-1?(a=z.indexOf(">",a),h=i(z.substring(0,a+1)),e=z.indexOf("</body",a),e==-1&&(e=z.length),B.content=z.substring(a+1,e),v=i(z.substring(e))):(h=q(),v="\n</body>\n</html>"),C=j(),p(C.getAll("style"),function(d){d.firstChild&&(c+=d.firstChild.value)}),A=C.getAll("body")[0],A&&u.setAttribs(k.getBody(),{style:A.attr("style")||"",dir:A.attr("dir")||"",vLink:A.attr("vlink")||"",link:A.attr("link")||"",aLink:A.attr("alink")||""}),u.remove("fullpage_styles");var l=k.getDoc().getElementsByTagName("head")[0];c&&(u.add(l,"style",{id:"fullpage_styles"},c),A=u.get("fullpage_styles"),A.styleSheet&&(A.styleSheet.cssText=c));var y={};tinymce.each(l.getElementsByTagName("link"),function(d){"stylesheet"==d.rel&&d.getAttribute("data-mce-fullpage")&&(y[d.href]=d)}),tinymce.each(C.getAll("link"),function(n){var d=n.attr("href");return !d||(y[d]||"stylesheet"!=n.attr("rel")||u.add(l,"link",{rel:"stylesheet",text:"text/css",href:d,"data-mce-fullpage":"1"}),void delete y[d])}),tinymce.each(y,function(d){d.parentNode.removeChild(d)})}}function q(){var a,d="",c="";return k.getParam("fullpage_default_xml_pi")&&(d+='<?xml version="1.0" encoding="'+k.getParam("fullpage_default_encoding","ISO-8859-1")+'" ?>\n'),d+=k.getParam("fullpage_default_doctype","<!DOCTYPE html>"),d+="\n<html>\n<head>\n",(a=k.getParam("fullpage_default_title"))&&(d+="<title>"+a+"</title>\n"),(a=k.getParam("fullpage_default_encoding"))&&(d+='<meta http-equiv="Content-Type" content="text/html; charset='+a+'" />\n'),(a=k.getParam("fullpage_default_font_family"))&&(c+="font-family: "+a+";"),(a=k.getParam("fullpage_default_font_size"))&&(c+="font-size: "+a+";"),(a=k.getParam("fullpage_default_text_color"))&&(c+="color: "+a+";"),d+="</head>\n<body"+(c?' style="'+c+'"':"")+">\n"}function x(a){a.selection||a.source_view&&k.getParam("fullpage_hide_in_source_view")||(a.content=tinymce.trim(h)+"\n"+tinymce.trim(a.content)+"\n"+tinymce.trim(v))}var h,v,p=tinymce.each,m=tinymce.html.Node;k.addCommand("mceFullPageProperties",w),k.addButton("fullpage",{title:"Document properties",cmd:"mceFullPageProperties"}),k.addMenuItem("fullpage",{text:"Document properties",cmd:"mceFullPageProperties",context:"file"}),k.on("BeforeSetContent",f),k.on("GetContent",x)});