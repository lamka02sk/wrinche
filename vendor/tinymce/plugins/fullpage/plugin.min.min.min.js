tinymce.PluginManager.add("fullpage",function(e){function t(){var b=n();e.windowManager.open({title:"Document properties",data:b,defaults:{type:"textbox",size:40},body:[{name:"title",label:"Title"},{name:"keywords",label:"Keywords"},{name:"description",label:"Description"},{name:"robots",label:"Robots"},{name:"author",label:"Author"},{name:"docencoding",label:"Encoding"}],onSubmit:function(f){r(tinymce.extend(b,f.data))}})}function n(){function h(p,k){var m=p.attr(k);return m||""}var b,g,f=i(),j={};return j.fontface=e.getParam("fullpage_default_fontface",""),j.fontsize=e.getParam("fullpage_default_fontsize",""),b=f.firstChild,7==b.type&&(j.xml_pi=!0,g=/encoding="([^"]+)"/.exec(b.value),g&&(j.docencoding=g[1])),b=f.getAll("#doctype")[0],b&&(j.doctype="<!DOCTYPE"+b.value+">"),b=f.getAll("title")[0],b&&b.firstChild&&(j.title=b.firstChild.value),c(f.getAll("meta"),function(p){var k,m=p.attr("name"),q=p.attr("http-equiv");m?j[m.toLowerCase()]=p.attr("content"):"Content-Type"==q&&(k=/charset\s*=\s*(.*)\s*/gi.exec(p.attr("content")),k&&(j.docencoding=k[1]))}),b=f.getAll("html")[0],b&&(j.langcode=h(b,"lang")||h(b,"xml:lang")),j.stylesheets=[],tinymce.each(f.getAll("link"),function(k){"stylesheet"==k.attr("rel")&&j.stylesheets.push(k.attr("href"))}),b=f.getAll("body")[0],b&&(j.langdir=h(b,"dir"),j.style=h(b,"style"),j.visited_color=h(b,"vlink"),j.link_color=h(b,"link"),j.active_color=h(b,"alink")),j}function r(f){function j(y,w,x){y.attr(w,x?x:void 0)}function p(w){q.firstChild?q.insert(w,q.firstChild):q.append(w)}var k,q,b,g,v,m=e.dom;k=i(),q=k.getAll("head")[0],q||(g=k.getAll("html")[0],q=new d("head",1),g.firstChild?g.insert(q,g.firstChild,!0):g.append(q)),g=k.firstChild,f.xml_pi?(v='version="1.0"',f.docencoding&&(v+=' encoding="'+f.docencoding+'"'),7!=g.type&&(g=new d("xml",7),k.insert(g,k.firstChild,!0)),g.value=v):g&&7==g.type&&g.remove(),g=k.getAll("#doctype")[0],f.doctype?(g||(g=new d("#doctype",10),f.xml_pi?k.insert(g,k.firstChild):p(g)),g.value=f.doctype.substring(9,f.doctype.length-1)):g&&g.remove(),g=null,c(k.getAll("meta"),function(w){"Content-Type"==w.attr("http-equiv")&&(g=w)}),f.docencoding?(g||(g=new d("meta",1),g.attr("http-equiv","Content-Type"),g.shortEnded=!0,p(g)),g.attr("content","text/html; charset="+f.docencoding)):g&&g.remove(),g=k.getAll("title")[0],f.title?(g?g.empty():(g=new d("title",1),p(g)),g.append(new d("#text",3)).value=f.title):g&&g.remove(),c("keywords,description,author,copyright,robots".split(","),function(w){var z,y,A=k.getAll("meta"),x=f[w];for(z=0;z<A.length;z++){if(y=A[z],y.attr("name")==w){return void (x?y.attr("content",x):y.remove())}}x&&(g=new d("meta",1),g.attr("name",w),g.attr("content",x),g.shortEnded=!0,p(g))});var h={};tinymce.each(k.getAll("link"),function(w){"stylesheet"==w.attr("rel")&&(h[w.attr("href")]=w)}),tinymce.each(f.stylesheets,function(w){h[w]||(g=new d("link",1),g.attr({rel:"stylesheet",text:"text/css",href:w}),g.shortEnded=!0,p(g)),delete h[w]}),tinymce.each(h,function(w){w.remove()}),g=k.getAll("body")[0],g&&(j(g,"dir",f.langdir),j(g,"style",f.style),j(g,"vlink",f.visited_color),j(g,"link",f.link_color),j(g,"alink",f.active_color),m.setAttribs(e.getBody(),{style:f.style,dir:f.dir,vLink:f.visited_color,link:f.link_color,aLink:f.active_color})),g=k.getAll("html")[0],g&&(j(g,"lang",f.langcode),j(g,"xml:lang",f.langcode)),q.firstChild||q.remove(),b=new tinymce.html.Serializer({validate:!1,indent:!0,apply_source_formatting:!0,indent_before:"head,html,body,meta,title,script,link,style",indent_after:"head,html,body,meta,title,script,link,style"}).serialize(k),l=b.substring(0,b.indexOf("</body>"))}function i(){return new tinymce.html.DomParser({validate:!1,root_name:"#document"}).parse(l)}function o(f){function j(x){return x.replace(/<\/?[A-Z]+/g,function(y){return y.toLowerCase()})}var v,k,b,g,p=f.content,m="",w=e.dom;if(!f.selection&&!("raw"==f.format&&l||f.source_view&&e.getParam("fullpage_hide_in_source_view"))){0!==p.length||f.source_view||(p=tinymce.trim(l)+"\n"+tinymce.trim(p)+"\n"+tinymce.trim(u)),p=p.replace(/<(\/?)BODY/gi,"<$1body"),v=p.indexOf("<body"),v!=-1?(v=p.indexOf(">",v),l=j(p.substring(0,v+1)),k=p.indexOf("</body",v),k==-1&&(k=p.length),f.content=p.substring(v+1,k),u=j(p.substring(k))):(l=a(),u="\n</body>\n</html>"),b=i(),c(b.getAll("style"),function(x){x.firstChild&&(m+=x.firstChild.value)}),g=b.getAll("body")[0],g&&w.setAttribs(e.getBody(),{style:g.attr("style")||"",dir:g.attr("dir")||"",vLink:g.attr("vlink")||"",link:g.attr("link")||"",aLink:g.attr("alink")||""}),w.remove("fullpage_styles");var h=e.getDoc().getElementsByTagName("head")[0];m&&(w.add(h,"style",{id:"fullpage_styles"},m),g=w.get("fullpage_styles"),g.styleSheet&&(g.styleSheet.cssText=m));var q={};tinymce.each(h.getElementsByTagName("link"),function(x){"stylesheet"==x.rel&&x.getAttribute("data-mce-fullpage")&&(q[x.href]=x)}),tinymce.each(b.getAll("link"),function(y){var x=y.attr("href");return !x||(q[x]||"stylesheet"!=y.attr("rel")||w.add(h,"link",{rel:"stylesheet",text:"text/css",href:x,"data-mce-fullpage":"1"}),void delete q[x])}),tinymce.each(q,function(x){x.parentNode.removeChild(x)})}}function a(){var b,f="",g="";return e.getParam("fullpage_default_xml_pi")&&(f+='<?xml version="1.0" encoding="'+e.getParam("fullpage_default_encoding","ISO-8859-1")+'" ?>\n'),f+=e.getParam("fullpage_default_doctype","<!DOCTYPE html>"),f+="\n<html>\n<head>\n",(b=e.getParam("fullpage_default_title"))&&(f+="<title>"+b+"</title>\n"),(b=e.getParam("fullpage_default_encoding"))&&(f+='<meta http-equiv="Content-Type" content="text/html; charset='+b+'" />\n'),(b=e.getParam("fullpage_default_font_family"))&&(g+="font-family: "+b+";"),(b=e.getParam("fullpage_default_font_size"))&&(g+="font-size: "+b+";"),(b=e.getParam("fullpage_default_text_color"))&&(g+="color: "+b+";"),f+="</head>\n<body"+(g?' style="'+g+'"':"")+">\n"}function s(b){b.selection||b.source_view&&e.getParam("fullpage_hide_in_source_view")||(b.content=tinymce.trim(l)+"\n"+tinymce.trim(b.content)+"\n"+tinymce.trim(u))}var l,u,c=tinymce.each,d=tinymce.html.Node;e.addCommand("mceFullPageProperties",t),e.addButton("fullpage",{title:"Document properties",cmd:"mceFullPageProperties"}),e.addMenuItem("fullpage",{text:"Document properties",cmd:"mceFullPageProperties",context:"file"}),e.on("BeforeSetContent",o),e.on("GetContent",s)});